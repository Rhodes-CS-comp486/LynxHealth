<div class="page">
  <header class="site-header">
    <div class="container nav">
      <div class="brand">
        <span class="brand-mark">LH</span>
        <span class="brand-text">Lynx Health</span>
      </div>
      <nav class="nav-links">
        <a routerLink="/home">Home</a>
        <a routerLink="/home" fragment="availability">Appointments</a>
        <a routerLink="/home" fragment="hours">Hours</a>
        <a *ngIf="role === 'admin'" routerLink="/create-appointments">Manage Availability</a>
      </nav>
      <div class="nav-actions">
        <span class="role-pill">{{ role === "admin" ? "Admin" : "User" }}</span>
        <a class="button small" routerLink="/login">Switch Role</a>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container calendar-panel">
        <div class="calendar-header">
          <div>
            <h1>Block Off Appointment Times</h1>
            <p class="section-copy">Weekdays only · 9:00 AM to 3:45 PM. Booked slots are marked and cannot be blocked.</p>
          </div>
          <div class="calendar-actions">
            <button class="button ghost" type="button" (click)="previousWeek()">Previous week</button>
            <strong>{{ calendarDays[0]?.date | date: 'MMM d' }} - {{ calendarDays[4]?.date | date: 'MMM d, y' }}</strong>
            <button class="button ghost" type="button" (click)="nextWeek()">Next week</button>
          </div>
        </div>

        <div class="table-wrap" *ngIf="role === 'admin' && calendarDays.length > 0; else nonAdmin">
          <table class="calendar-table">
            <thead>
              <tr>
                <th>Time</th>
                <th *ngFor="let day of calendarDays">{{ day.label }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of calendarRows; let rowIndex = index">
                <th>
                  <span *ngIf="row[0].hourLabel">{{ row[0].hourLabel }}</span>
                </th>
                <td *ngFor="let cell of row">
                  <button
                    *ngIf="!cell.isPast"
                    type="button"
                    class="cell"
                    [ngClass]="{ blocked: !cell.isBooked && !!cell.blockedId, booked: cell.isBooked }"
                    [disabled]="isSaving || cell.isBooked"
                    (click)="toggleBlocked(cell)">
                    {{ cell.isBooked ? 'Booked' : (cell.blockedId ? 'Blocked' : 'Available') }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #nonAdmin>
          <p class="error" *ngIf="role !== 'admin'">Only admins can manage blocked times.</p>
          <p class="error" *ngIf="role === 'admin'">No future slots are available in this week.</p>
        </ng-template>

        <p class="success" *ngIf="adminMessage">{{ adminMessage }}</p>
        <p class="error" *ngIf="adminError">{{ adminError }}</p>

        <div class="booked-panel" *ngIf="role === 'admin'">
          <h2>Upcoming Student Appointments</h2>
          <p class="section-copy">Student comments/notes for the currently viewed week are listed here.</p>

          <p class="empty-state" *ngIf="bookedAppointmentsForVisibleWeek.length === 0">No upcoming appointments in this week.</p>

          <div class="booked-list" *ngIf="bookedAppointmentsForVisibleWeek.length > 0">
            <article class="booked-card" *ngFor="let appointment of bookedAppointmentsForVisibleWeek">
              <p><strong>{{ appointment.start_time | date: 'EEE, MMM d, y, h:mm a' }}</strong> to {{ appointment.end_time | date: 'h:mm a' }}</p>
              <p>{{ appointment.duration_minutes }} mins · {{ appointment.appointment_type }}</p>
              <p>Student: {{ appointment.student_email }}</p>
              <p class="notes"><strong>Notes:</strong> {{ appointment.notes || 'No notes provided.' }}</p>
            </article>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
