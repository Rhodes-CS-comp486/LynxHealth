<div class="page">
  <header class="site-header">
    <div class="container nav">
      <div class="brand">
        <span class="brand-mark">LH</span>
        <span class="brand-text">Lynx Health</span>
      </div>
      <nav class="nav-links">
        <a routerLink="/home">Home</a>
        <a routerLink="/home" fragment="resources">Resources</a>
        <a routerLink="/home" fragment="hours">Hours</a>
        <a *ngIf="role === 'admin'" routerLink="/create-appointments">Manage Availability</a>
      </nav>
      <div class="nav-actions">
        <span class="role-pill">{{ role === "admin" ? "Admin" : "User" }}</span>
        <a class="button small" routerLink="/login">Switch Role</a>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container calendar-panel">
        <h1>Appointment Availability Calendar</h1>
        <p class="section-copy">Choose an appointment type first, then view and book open slots for the next 2 weeks.</p>

        <div class="filters">
          <label>
            Appointment type
            <select [(ngModel)]="selectedAppointmentType" (change)="onAppointmentTypeChange()">
              <option value="">Choose type</option>
              <option *ngFor="let option of appointmentTypeOptions" [value]="option.appointment_type">
                {{ formatAppointmentType(option.appointment_type) }} ({{ option.duration_minutes }} mins)
              </option>
            </select>
          </label>

          <label>
            Time of day
            <select [(ngModel)]="selectedTimeOfDay" (change)="onTimeOfDayChange()">
              <option value="all">All day</option>
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
            </select>
          </label>
        </div>

        <p class="error" *ngIf="error">{{ error }}</p>

        <div class="calendar-week-header" *ngIf="selectedAppointmentType">
          <h2>Weekly Calendar</h2>
          <div class="calendar-week-actions">
            <button class="button ghost week-toggle" type="button" (click)="showCurrentWeek()" [disabled]="!canShowCurrentWeek">
              Current Week
            </button>
            <strong>{{ weekRangeLabel }}</strong>
            <button class="button week-toggle" type="button" (click)="showNextWeek()" [disabled]="!canShowNextWeek">
              Next Week
            </button>
          </div>
        </div>

        <div class="notice-card" *ngIf="!selectedAppointmentType">
          Select an appointment type to view matching slots.
        </div>

        <div class="notice-card" *ngIf="selectedAppointmentType && filteredSlots.length === 0">
          No available slots match your selected criteria.
        </div>

        <div class="booking-panel" *ngIf="role === 'user' && selectedBookingSlot">
          <h3>Confirm Appointment</h3>
          <p>
            {{ selectedBookingSlot.start_time | date: 'EEE, MMM d, y' }}
            · {{ selectedBookingSlot.start_time | date: 'h:mm a' }} to {{ selectedBookingSlot.end_time | date: 'h:mm a' }}
            · {{ formatAppointmentType(selectedBookingSlot.appointment_type) }}
          </p>
          <label>
            Comments or notes for admin (optional)
            <textarea
              [(ngModel)]="bookingNotes"
              rows="4"
              maxlength="600"
              placeholder="Add details that can help staff prepare for your visit."></textarea>
          </label>
          <div class="booking-actions">
            <button class="button ghost" type="button" (click)="cancelBooking()" [disabled]="isBooking">
              Cancel
            </button>
            <button class="button" type="button" (click)="submitBooking()" [disabled]="isBooking">
              {{ isBooking ? 'Booking...' : 'Confirm Appointment' }}
            </button>
          </div>
        </div>

        <div class="confirmation-panel" *ngIf="confirmedBooking">
          <h3>Booking Confirmed</h3>
          <p>Your appointment is confirmed and the calendar below has been updated.</p>
          <p>
            <strong>Date:</strong> {{ confirmedBooking.start_time | date: 'EEE, MMM d, y' }}
            · <strong>Time:</strong> {{ confirmedBooking.start_time | date: 'h:mm a' }} to {{ confirmedBooking.end_time | date: 'h:mm a' }}
          </p>
          <p>
            <strong>Type:</strong> {{ formatAppointmentType(confirmedBooking.appointment_type) }}
            · <strong>Duration:</strong> {{ confirmedBooking.duration_minutes }} mins
          </p>
          <p><strong>Notes:</strong> {{ confirmedBooking.notes || 'No notes provided.' }}</p>
        </div>
        <p class="error" *ngIf="bookingError">{{ bookingError }}</p>

        <div class="week-grid" *ngIf="selectedAppointmentType && filteredSlots.length > 0">
          <article class="week-day" *ngFor="let day of visibleWeekDays">
            <h3>{{ day.label }}</h3>
            <div class="day-slot-list" *ngIf="slotsForDay(day.key).length > 0; else noDaySlots">
              <article class="slot-card" *ngFor="let slot of slotsForDay(day.key)">
                <p>{{ slot.start_time | date: 'h:mm a' }} to {{ slot.end_time | date: 'h:mm a' }}</p>
                <p>{{ slot.duration_minutes }} mins · {{ formatAppointmentType(slot.appointment_type) }}</p>
                <span class="slot-state">Available</span>
                <button *ngIf="role === 'user'" class="button book-button" type="button" (click)="beginBooking(slot)">
                  Book This Time
                </button>
                <span class="admin-view-note" *ngIf="role === 'admin'">Admin view</span>
              </article>
            </div>
            <ng-template #noDaySlots>
              <p class="empty-day">No slots</p>
            </ng-template>
          </article>
        </div>
      </div>
    </section>
  </main>
</div>
