<div class="page">
  <header class="site-header">
    <div class="container nav">
      <div class="brand">
        <span class="brand-mark">LH</span>
        <span class="brand-text">Lynx Health</span>
      </div>
      <nav class="nav-links">
        <a routerLink="/home">Home</a>
        <a routerLink="/availability-calendar">Book Appointment</a>
        <a routerLink="/home" fragment="resources">Resources</a>
      </nav>
      <div class="nav-actions">
        <a class="button small" routerLink="/login">Switch Role</a>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container panel">
        <h1>My Upcoming Appointments</h1>
        <p class="section-copy">Review upcoming bookings and update notes shared with the health center.</p>

        <p class="error" *ngIf="error">{{ error }}</p>
        <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
        <p class="success" *ngIf="saveSuccess">{{ saveSuccess }}</p>
        <p class="error" *ngIf="saveError">{{ saveError }}</p>
        <p class="section-copy" *ngIf="isLoading">Loading your appointments...</p>

        <div class="empty-state" *ngIf="!isLoading && !error && appointments.length === 0">
          You have no upcoming appointments.
        </div>

        <div class="appointments" *ngIf="!isLoading && appointments.length > 0">
          <article class="appointment-card" *ngFor="let appointment of appointments">
            <h3>{{ appointment.start_time | date: 'EEEE, MMM d, y' }}</h3>
            <p>
              {{ appointment.start_time | date: 'h:mm a' }} to {{ appointment.end_time | date: 'h:mm a' }}
              Â· {{ formatAppointmentType(appointment.appointment_type) }} ({{ appointment.duration_minutes }} mins)
            </p>
            <p><strong>Status:</strong> {{ appointment.status }}</p>

            <ng-container *ngIf="editingAppointmentId !== appointment.id; else editNotesTemplate">
              <p><strong>Notes:</strong> {{ appointment.notes || 'No notes provided.' }}</p>
              <button class="button small" type="button" (click)="startEditing(appointment)">Edit notes</button>
            </ng-container>

            <ng-template #editNotesTemplate>
              <label class="notes-label" [for]="'notes-' + appointment.id"><strong>Notes:</strong></label>
              <textarea
                class="notes-input"
                [id]="'notes-' + appointment.id"
                rows="4"
                maxlength="600"
                [value]="draftNotesById[appointment.id] || ''"
                (input)="updateDraftNotes(appointment.id, $any($event.target).value)"></textarea>
              <div class="actions-row">
                <button class="button small" type="button" [disabled]="savingAppointmentId === appointment.id" (click)="saveNotes(appointment)">
                  {{ savingAppointmentId === appointment.id ? 'Saving...' : 'Save notes' }}
                </button>
                <button class="button small ghost" type="button" [disabled]="savingAppointmentId === appointment.id" (click)="cancelEditing()">
                  Cancel
                </button>
              </div>
            </ng-template>

            <div class="appointment-actions-row">
              <button
                class="button small"
                type="button"
                [disabled]="reschedulingAppointmentId === appointment.id || isLoadingRescheduleOptions"
                (click)="openReschedulePanel(appointment)">
                {{ reschedulePanelAppointmentId === appointment.id ? 'Close reschedule' : 'Reschedule appointment' }}
              </button>
              <button
                class="button small cancel-button"
                type="button"
                [disabled]="cancelingAppointmentId === appointment.id"
                (click)="cancelAppointment(appointment.id)">
                {{ cancelingAppointmentId === appointment.id ? 'Canceling...' : 'Cancel appointment' }}
              </button>
            </div>

            <section class="reschedule-panel" *ngIf="reschedulePanelAppointmentId === appointment.id">
              <h4>Pick a new time</h4>
              <p class="section-copy">
                Current time: {{ appointment.start_time | date: 'EEE, MMM d, y, h:mm a' }}
              </p>

              <p class="section-copy" *ngIf="isLoadingRescheduleOptions">Loading available times...</p>
              <p class="section-copy" *ngIf="!isLoadingRescheduleOptions && rescheduleOptions.length === 0">
                No available times were found in the next 14 days.
              </p>

              <div class="reschedule-day-group" *ngFor="let group of rescheduleOptions">
                <h5>{{ group.slots[0].start_time | date: 'EEEE, MMM d' }}</h5>
                <div class="slot-grid">
                  <button
                    class="button small ghost time-slot"
                    type="button"
                    *ngFor="let slot of group.slots"
                    [class.selected]="selectedRescheduleStartTime === slot.start_time"
                    (click)="selectRescheduleTime(slot.start_time)">
                    {{ slot.start_time | date: 'h:mm a' }}
                  </button>
                </div>
              </div>

              <div class="actions-row">
                <button
                  class="button small"
                  type="button"
                  [disabled]="!selectedRescheduleStartTime || reschedulingAppointmentId === appointment.id"
                  (click)="confirmReschedule(appointment)">
                  {{ reschedulingAppointmentId === appointment.id ? 'Rescheduling...' : 'Confirm new time' }}
                </button>
                <button
                  class="button small ghost"
                  type="button"
                  [disabled]="reschedulingAppointmentId === appointment.id"
                  (click)="closeReschedulePanel()">
                  Keep current time
                </button>
              </div>
            </section>
          </article>
        </div>
      </div>
    </section>
  </main>
</div>
